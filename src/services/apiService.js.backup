/**
 * APIé€šä¿¡ã‚µãƒ¼ãƒ“ã‚¹
 */

import { calculateSimilarity } from '../utils/comparisonUtils';

// ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´åº¦ã«ã‚ˆã‚‹æ¤œç´¢çµæœã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨é †ä½ä»˜ã‘
const filterAndRankByTitle = (results, parsedInfo) => {
  if (!parsedInfo.title || results.length === 0) {
    return results;
  }

  const originalTitle = parsedInfo.title.toLowerCase().trim();
  console.log(`ğŸ“‹ ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´åº¦åˆ†æ: "${originalTitle}"`);

  // å®Œå…¨ä¸€è‡´ã‚’æœ€å„ªå…ˆã§æ¤œç´¢
  const exactMatches = results.filter(result => {
    if (!result.title) return false;
    const resultTitle = result.title.toLowerCase().trim();
    const isExact = resultTitle === originalTitle;
    if (isExact) {
      console.log(`ğŸ¯ å®Œå…¨ä¸€è‡´ç™ºè¦‹: "${result.title}"`);
    }
    return isExact;
  });

  if (exactMatches.length > 0) {
    console.log(`âœ… ${exactMatches.length}ä»¶ã®å®Œå…¨ä¸€è‡´ã‚’è¿”å´`);
    return exactMatches;
  }

  // éƒ¨åˆ†ä¸€è‡´ã®å ´åˆã€é¡ä¼¼åº¦ã§ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½ã‚’è¿”ã™
  const partialMatches = results
    .map(result => {
      if (!result.title) return { ...result, similarity: 0 };
      
      const similarity = calculateSimilarity(originalTitle, result.title.toLowerCase().trim());
      
      // æ²è¼‰èªŒåã‚‚è€ƒæ…®ã—ã¦ã‚¹ã‚³ã‚¢ã‚’èª¿æ•´
      let adjustedScore = similarity;
      if (parsedInfo.journal && result.journal) {
        const journalSimilarity = calculateSimilarity(
          parsedInfo.journal.toLowerCase().trim(),
          result.journal.toLowerCase().trim()
        );
        // ã‚¿ã‚¤ãƒˆãƒ«80% + æ²è¼‰èªŒå20%ã®é‡ã¿ä»˜ã‘
        adjustedScore = similarity * 0.8 + journalSimilarity * 0.2;
      }
      
      return { ...result, similarity, adjustedScore };
    })
    .filter(result => result.similarity >= 40) // é–¾å€¤ã‚’ç·©å’Œ 60% â†’ 40%
    .sort((a, b) => b.adjustedScore - a.adjustedScore)
    .slice(0, 8); // å„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ä¸Šä½8ä»¶ã¾ã§

  console.log(`ğŸ“Š éƒ¨åˆ†ä¸€è‡´çµæœ: ${partialMatches.length}ä»¶ (40%ä»¥ä¸Šã®é¡ä¼¼åº¦)`);
  partialMatches.forEach(result => {
    console.log(`  - "${result.title}" (é¡ä¼¼åº¦: ${result.similarity.toFixed(1)}%, èª¿æ•´ã‚¹ã‚³ã‚¢: ${result.adjustedScore.toFixed(1)}%)`);
  });

  return partialMatches;
};

// APIè¨­å®š
const isDevelopment = process.env.NODE_ENV === 'development';
const API_BASE = isDevelopment ? 'http://localhost:3001' : '';

const API_CONFIG = {
  CROSSREF: {
    endpoint: `${API_BASE}/api/crossref`,
    timeout: 10000
  },
  SEMANTIC_SCHOLAR: {
    endpoint: `${API_BASE}/api/semantic-scholar`,
    timeout: 10000
  },
  CINII: {
    endpoint: `${API_BASE}/api/cinii`,
    timeout: 10000
  }
};

// APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
const fetchWithTimeout = async (url, options = {}, timeout = 10000) => {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal
    });
    clearTimeout(id);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === 'AbortError') {
      throw new Error('Request timeout');
    }
    throw error;
  }
};

// æ®µéšçš„æ¤œç´¢æˆ¦ç•¥ï¼šã‚ˆã‚Šå…·ä½“çš„ãªæ¤œç´¢ã‹ã‚‰å§‹ã‚ã¦ã€æ®µéšçš„ã«æ¤œç´¢ç¯„å›²ã‚’åºƒã’ã‚‹
const executeGradualSearch = async (parsedInfo, searchFunc) => {
  const allResults = [];
  
  // æ®µéš1: ã‚¿ã‚¤ãƒˆãƒ« + è‘—è€…å + æ²è¼‰èªŒå (æœ€ã‚‚å…·ä½“çš„)
  if (parsedInfo.title && parsedInfo.authors?.length > 0 && parsedInfo.journal) {
    const authorName = parsedInfo.authors[0]; // ç¬¬ä¸€è‘—è€…
    const query1 = `"${parsedInfo.title}" "${authorName}" "${parsedInfo.journal}"`;
    console.log(`ğŸ¯ æ®µéš1æ¤œç´¢: ã‚¿ã‚¤ãƒˆãƒ«+è‘—è€…+æ²è¼‰èªŒ - "${query1}"`);
    const results1 = await searchFunc(query1, 5);
    if (results1.length > 0) {
      console.log(`âœ… æ®µéš1ã§${results1.length}ä»¶ç™ºè¦‹`);
      allResults.push(...results1);
    }
  }
  
  // æ®µéš2: ã‚¿ã‚¤ãƒˆãƒ« + æ²è¼‰èªŒå (åŸè‘—è«–æ–‡ã‚’å„ªå…ˆçš„ã«ç™ºè¦‹)
  if (parsedInfo.title && parsedInfo.journal && allResults.length < 3) {
    const query2 = `"${parsedInfo.title}" "${parsedInfo.journal}"`;
    console.log(`ğŸ¯ æ®µéš2æ¤œç´¢: ã‚¿ã‚¤ãƒˆãƒ«+æ²è¼‰èªŒ - "${query2}"`);
    const results2 = await searchFunc(query2, 8);
    if (results2.length > 0) {
      console.log(`âœ… æ®µéš2ã§${results2.length}ä»¶ç™ºè¦‹`);
      // é‡è¤‡ã‚’é™¤å»ã—ã¦è¿½åŠ 
      const uniqueResults2 = results2.filter(r2 => 
        !allResults.some(r1 => r1.title === r2.title)
      );
      allResults.push(...uniqueResults2);
    }
  }
  
  // æ®µéš3: ã‚¿ã‚¤ãƒˆãƒ« + è‘—è€…å
  if (parsedInfo.title && parsedInfo.authors?.length > 0 && allResults.length < 5) {
    const authorName = parsedInfo.authors[0];
    const query3 = `"${parsedInfo.title}" "${authorName}"`;
    console.log(`ğŸ¯ æ®µéš3æ¤œç´¢: ã‚¿ã‚¤ãƒˆãƒ«+è‘—è€… - "${query3}"`);
    const results3 = await searchFunc(query3, 8);
    if (results3.length > 0) {
      console.log(`âœ… æ®µéš3ã§${results3.length}ä»¶ç™ºè¦‹`);
      const uniqueResults3 = results3.filter(r3 => 
        !allResults.some(r1 => r1.title === r3.title)
      );
      allResults.push(...uniqueResults3);
    }
  }
  
  // æ®µéš4: ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ (å¾“æ¥ã®æ¤œç´¢)
  if (parsedInfo.title && allResults.length < 8) {
    console.log(`ğŸ¯ æ®µéš4æ¤œç´¢: ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ - "${parsedInfo.title}"`);
    const results4 = await searchFunc(parsedInfo.title, 10);
    if (results4.length > 0) {
      console.log(`âœ… æ®µéš4ã§${results4.length}ä»¶ç™ºè¦‹`);
      const uniqueResults4 = results4.filter(r4 => 
        !allResults.some(r1 => r1.title === r4.title)
      );
      allResults.push(...uniqueResults4);
    }
  }
  
  console.log(`ğŸ“Š æ®µéšçš„æ¤œç´¢å®Œäº†: è¨ˆ${allResults.length}ä»¶ã®å€™è£œ`);
  return allResults;
};

// CrossRef APIæ¤œç´¢ï¼ˆæ®µéšçš„æ¤œç´¢æˆ¦ç•¥ï¼‰
const searchCrossRef = async (parsedInfo) => {
  if (!parsedInfo.title || parsedInfo.title.trim() === '') {
    console.warn('CrossRef: ã‚¿ã‚¤ãƒˆãƒ«ãŒãªã„ãŸã‚æ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—');
    return [];
  }

  console.log(`ğŸ” CrossRef æ®µéšçš„æ¤œç´¢é–‹å§‹`);

  // CrossRefå°‚ç”¨ã®æ¤œç´¢å®Ÿè¡Œé–¢æ•°
  const executeSearch = async (query, limit = 10) => {
    let queryParams = new URLSearchParams({
      query: query,
      rows: limit.toString()
    });

    try {
    let response = await fetchWithTimeout(
      `${API_CONFIG.CROSSREF.endpoint}?${queryParams}`,
      {},
      API_CONFIG.CROSSREF.timeout
    );

    if (!response.ok) {
      console.error('CrossRef API error:', response.status);
      return [];
    }

    const data = await response.json();
    
    if (data.message && data.message.items) {
      const allResults = data.message.items.map(item => ({
        title: item.title?.[0] || '',
        authors: item.author ? item.author.map(a => `${a.given || ''} ${a.family || ''}`.trim()) : [],
        year: item.published?.['date-parts']?.[0]?.[0]?.toString() || '',
        doi: item.DOI || '',
        journal: item['container-title']?.[0] || item.publisher || '',
        volume: item.volume || '',
        issue: item.issue || '',
        pages: item.page || '',
        url: item.URL || '',
        source: 'CrossRef',
        originalData: item
      }));

      // ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´åº¦ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
      return filterAndRankByTitle(allResults, parsedInfo);
    }
    
    return [];
  } catch (error) {
    console.error('CrossRef API error:', error);
    return [];
    }
  };

  // æ®µéšçš„æ¤œç´¢ã‚’å®Ÿè¡Œ
  return await executeGradualSearch(parsedInfo, executeSearch);
};

// Semantic Scholar APIæ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸­å¿ƒæˆ¦ç•¥ï¼‰  
const searchSemanticScholar = async (parsedInfo) => {
  if (!parsedInfo.title || parsedInfo.title.trim() === '') {
    console.warn('Semantic Scholar: ã‚¿ã‚¤ãƒˆãƒ«ãŒãªã„ãŸã‚æ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—');
    return [];
  }

  console.log(`ğŸ¯ Semantic Scholar ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢: "${parsedInfo.title}"`);

  // çŸ­ã„ã‚¿ã‚¤ãƒˆãƒ«ã®å ´åˆã¯æ²è¼‰èªŒåã‚‚å«ã‚ã¦æ¤œç´¢
  let query = parsedInfo.title;
  const isShortTitle = parsedInfo.title.length <= 20;
  
  if (isShortTitle && parsedInfo.journal) {
    query = `${parsedInfo.title} ${parsedInfo.journal}`;
    console.log(`ğŸ“‹ çŸ­ã„ã‚¿ã‚¤ãƒˆãƒ«æ¤œå‡º - æ²è¼‰èªŒåä½µç”¨æ¤œç´¢: "${query}"`);
  }

  const queryParams = new URLSearchParams({
    query: query,
    limit: '15',
    fields: 'title,authors,year,venue,doi,url'
  });

  try {
    const response = await fetchWithTimeout(
      `${API_CONFIG.SEMANTIC_SCHOLAR.endpoint}?${queryParams}`,
      {},
      API_CONFIG.SEMANTIC_SCHOLAR.timeout
    );

    if (!response.ok) {
      console.error('Semantic Scholar API error:', response.status);
      return [];
    }

    const data = await response.json();
    
    if (data.data) {
      const allResults = data.data.map(item => ({
        title: item.title || '',
        authors: item.authors ? item.authors.map(a => a.name) : [],
        year: item.year?.toString() || '',
        doi: item.doi || '',
        journal: item.venue || '',
        volume: '', // Semantic Scholarã¯å·»å·æƒ…å ±ã‚’æä¾›ã—ãªã„
        issue: '',
        pages: '',
        url: item.url || '',
        source: 'Semantic Scholar',
        originalData: item
      }));

      // ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´åº¦ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
      return filterAndRankByTitle(allResults, parsedInfo);
    }
    
    return [];
  } catch (error) {
    console.error('Semantic Scholar API error:', error);
    return [];
  }
};

// CiNii APIæ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸­å¿ƒæˆ¦ç•¥ï¼‰
const searchCiNii = async (parsedInfo) => {
  console.log('ğŸ” CiNiiæ¤œç´¢é–‹å§‹ - parsedInfo:', {
    title: parsedInfo.title,
    language: parsedInfo.language,
    authors: parsedInfo.authors
  });
  
  if (!parsedInfo.title || parsedInfo.title.trim() === '') {
    console.warn('âŒ CiNii: ã‚¿ã‚¤ãƒˆãƒ«ãŒãªã„ãŸã‚æ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—');
    return [];
  }

  console.log(`ğŸ¯ CiNii ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢: "${parsedInfo.title}"`);

  // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¸­å¿ƒã¨ã—ãŸæ¤œç´¢èªã‚’æ§‹æˆ
  const searchTerm = parsedInfo.title;

  const queryParams = new URLSearchParams({
    q: searchTerm,
    count: '20',
    start: '1',
    format: 'rss'
  });

  console.log('ğŸŒ CiNii APIå‘¼ã³å‡ºã— URL:', `${API_CONFIG.CINII.endpoint}?${queryParams}`);
  
  try {
    const response = await fetchWithTimeout(
      `${API_CONFIG.CINII.endpoint}?${queryParams}`,
      {},
      API_CONFIG.CINII.timeout
    );

    if (!response.ok) {
      console.error('âŒ CiNii API error:', response.status, response.statusText);
      return [];
    }
    
    console.log('âœ… CiNii API response received, status:', response.status);

    const responseText = await response.text();
    console.log('ğŸ“œ CiNii RSS response length:', responseText.length);
    console.log('ğŸ“„ CiNii RSS response preview:', responseText.substring(0, 500));
    
    // RSSå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(responseText, 'text/xml');
    const items = xmlDoc.querySelectorAll('item');
    
    console.log('ğŸ“Š CiNii found items count:', items.length);
    
    if (items.length > 0) {
      const allResults = Array.from(items).map(item => {
        // RSSè¦ç´ ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
        const title = item.querySelector('title')?.textContent || '';
        
        // è‘—è€…åã‚’æŠ½å‡º (dc:creator)
        const creators = item.querySelectorAll('dc\\:creator, creator');
        const authors = Array.from(creators).map(creator => creator.textContent || '');
        
        // æ²è¼‰èªŒåã‚’æŠ½å‡º (prism:publicationName)
        const journalEl = item.querySelector('prism\\:publicationName, publicationName');
        const journal = journalEl?.textContent || '';
        
        // å‡ºç‰ˆå¹´ã‚’æŠ½å‡º (è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª)
        const dateSelectors = [
          'prism\\:publicationDate', 'publicationDate',
          'dc\\:date', 'date',
          'prism\\:datePublished', 'datePublished',
          'pubDate'
        ];
        
        let year = '';
        let dateText = '';
        
        for (const selector of dateSelectors) {
          const dateEl = item.querySelector(selector);
          if (dateEl && dateEl.textContent) {
            dateText = dateEl.textContent;
            const yearMatch = dateText.match(/\d{4}/);
            if (yearMatch) {
              year = yearMatch[0];
              break;
            }
          }
        }
        
        // å¹´å·ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log(`ğŸ“… å¹´å·æŠ½å‡º: "${title.substring(0, 30)}..." dateText="${dateText}" year="${year}"`);
        
        // URL (linkè¦ç´ )
        const linkEl = item.querySelector('link');
        const url = linkEl?.textContent || '';
        
        // DOI (dc:identifier)
        const doiEl = item.querySelector('dc\\:identifier, identifier');
        const doi = doiEl?.textContent || '';
        
        // å·»å·ãƒ»ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æŠ½å‡º (prism:volume, prism:number, prism:startingPage, prism:endingPage)
        const volumeEl = item.querySelector('prism\\:volume, volume');
        const volume = volumeEl?.textContent || '';
        
        const numberEl = item.querySelector('prism\\:number, number');
        const issue = numberEl?.textContent || '';
        
        const startPageEl = item.querySelector('prism\\:startingPage, startingPage');
        const endPageEl = item.querySelector('prism\\:endingPage, endingPage');
        const startPage = startPageEl?.textContent || '';
        const endPage = endPageEl?.textContent || '';
        
        // ãƒšãƒ¼ã‚¸ç¯„å›²ã‚’æ§‹ç¯‰
        let pages = '';
        if (startPage && endPage) {
          pages = `${startPage}-${endPage}`;
        } else if (startPage) {
          pages = startPage;
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log(`ğŸ“‹ CiNiiè¨˜äº‹: "${title.substring(0, 30)}..."`, {
          volume: volume || '(ãªã—)',
          issue: issue || '(ãªã—)', 
          pages: pages || '(ãªã—)',
          journal: journal || '(ãªã—)'
        });
        
        return {
          title,
          authors,
          year,
          doi,
          journal,
          volume,
          issue,
          pages,
          url,
          source: 'CiNii',
          originalData: {
            title: title,
            creators: authors,
            journal: journal,
            date: dateText,
            volume: volume,
            issue: issue,
            pages: pages,
            link: url,
            doi: doi
          }
        };
      });

      // ã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´åº¦ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
      return filterAndRankByTitle(allResults, parsedInfo);
    }
    
    return [];
  } catch (error) {
    console.error('CiNii API error:', error);
    return [];
  }
};

// çµ±åˆæ¤œç´¢é–¢æ•°
export const searchAllDatabases = async (parsedInfo, onProgress) => {
  const results = {
    crossref: [],
    semanticScholar: [],
    cinii: []
  };

  console.log(`ğŸŒ æ¤œç´¢é–‹å§‹ - è¨€èª: ${parsedInfo.language}, ã‚¿ã‚¤ãƒˆãƒ«: ${parsedInfo.title?.substring(0, 30)}...`);

  // è¨€èªã«å¿œã˜ã¦æ¤œç´¢é †åºã¨å¯¾è±¡ã‚’å¤‰æ›´
  let searchOrder;
  console.log('ğŸ” è¨€èªåˆ¤å®šçµæœ:', parsedInfo.language);
  
  if (parsedInfo.language === 'japanese') {
    // æ—¥æœ¬èªã®å ´åˆã¯CiNiiã‚’æœ€å„ªå…ˆã€CrossRefã¯è£œåŠ©çš„ã«
    searchOrder = ['cinii', 'crossref'];
    console.log('ğŸ“š æ—¥æœ¬èªæ–‡çŒ®ã¨ã—ã¦æ¤œç´¢: CiNii â†’ CrossRef');
  } else {
    // è‹±èªã®å ´åˆã¯å¾“æ¥é€šã‚Š
    searchOrder = ['crossref', 'semanticScholar'];
    console.log('ğŸ“– è‹±èªæ–‡çŒ®ã¨ã—ã¦æ¤œç´¢: CrossRef â†’ Semantic Scholar');
  }
  
  console.log('ğŸ“ æ¤œç´¢é †åº:', searchOrder);

  for (const source of searchOrder) {
    if (onProgress) {
      onProgress(source, 'searching');
    }

    try {
      let searchResults = [];
      
      console.log(`ğŸ” ${source} æ¤œç´¢é–‹å§‹...`);
      
      switch (source) {
        case 'crossref':
          searchResults = await searchCrossRef(parsedInfo);
          results.crossref = searchResults;
          break;
        case 'semanticScholar':
          searchResults = await searchSemanticScholar(parsedInfo);
          results.semanticScholar = searchResults;
          break;
        case 'cinii':
          searchResults = await searchCiNii(parsedInfo);
          results.cinii = searchResults;
          break;
        default:
          console.warn(`Unknown search source: ${source}`);
          break;
      }

      console.log(`âœ… ${source} æ¤œç´¢å®Œäº†: ${searchResults.length}ä»¶ã®çµæœ`);
      
      if (onProgress) {
        onProgress(source, 'completed', searchResults.length);
      }
    } catch (error) {
      console.error(`âŒ ${source} æ¤œç´¢ã‚¨ãƒ©ãƒ¼:`, error);
      if (onProgress) {
        onProgress(source, 'error');
      }
    }
  }

  // å…¨çµæœã‚’çµ±åˆã—ã¦è¿”ã™
  return [
    ...results.crossref,
    ...results.semanticScholar,
    ...results.cinii
  ];
};

// é–¢æ•°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export { searchCrossRef, searchSemanticScholar, searchCiNii };